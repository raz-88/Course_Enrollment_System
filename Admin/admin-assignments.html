<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin â€“ Assignments</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>

<style>
body{margin:0;font-family:system-ui;background:#f5f7fb;color:#111}
.container{max-width:1200px;margin:auto;padding:16px}

header{background:#0f172a;color:#fff;padding:14px}
h2{margin:0}

.card{
  background:#fff;
  border-radius:16px;
  padding:18px;
  box-shadow:0 6px 20px rgba(15,23,42,.08);
  margin-top:16px
}

input,textarea{
  width:100%;
  padding:10px;
  border-radius:10px;
  border:1px solid #d1d5db;
  margin:6px 0;
  font-size:.9rem
}

button{
  padding:7px 14px;
  border:none;
  border-radius:999px;
  cursor:pointer;
  font-size:.85rem;
  background:#1b5e20;
  color:#fff
}
button.secondary{background:#475569}
button.outline{
  background:transparent;
  border:1px solid #d1d5db;
  color:#111
}
button.danger{background:#b91c1c}

.assign{
  border:1px solid #e5e7eb;
  border-radius:14px;
  padding:14px;
  margin-bottom:12px
}

.meta{font-size:.8rem;color:#6b7280}
.actions{display:flex;gap:6px;flex-wrap:wrap;margin-top:10px}
</style>
</head>

<body>

<header>
  <div class="container">
    <h2>ðŸ“¤ Admin Assignments</h2>
  </div>
</header>

<div class="container">

<div class="card">
  <h3 id="formTitle">Create Assignment</h3>
  <input id="title" placeholder="Assignment title">
  <textarea id="desc" placeholder="Assignment description"></textarea>
  <label>Deadline</label>
  <input type="datetime-local" id="deadline">
  <button onclick="saveAssignment()">Save</button>
  <button class="outline" onclick="resetForm()">Cancel</button>
</div>

<div class="card">
  <h3>Assignments</h3>
  <div id="list"></div>
</div>

</div>

<script>
/* ================= FIREBASE ================= */
const firebaseConfig={
  apiKey:"AIzaSyBjcNmWxI91atAcnv1ALZM4723Cer6OFGo",
  authDomain:"student-enrollment-39c2f.firebaseapp.com",
  databaseURL:"https://student-enrollment-39c2f-default-rtdb.firebaseio.com",
  projectId:"student-enrollment-39c2f",
  storageBucket:"student-enrollment-39c2f.firebasestorage.app",
  messagingSenderId:"810600465736",
  appId:"1:810600465736:web:953640e6f15a530ee25f7d"
};
firebase.initializeApp(firebaseConfig);

const db=firebase.database();
const auth=firebase.auth();

const courseId=new URLSearchParams(location.search).get("courseId");
let editId=null;

/* ================= AUTH ================= */
auth.onAuthStateChanged(u=>{
  if(!u) location.href="../auth.html";
  loadAssignments();
});

/* ================= SAVE ================= */
async function saveAssignment(){
  if(!title.value || !deadline.value){
    alert("Title & deadline required");
    return;
  }

  const data={
    title:title.value,
    description:desc.value,
    deadline:deadline.value,
    active:true,
    updatedAt:Date.now()
  };

  if(editId){
    await db.ref(`requirements/${courseId}/${editId}`).update(data);
  }else{
    data.createdAt=Date.now();
    await db.ref(`requirements/${courseId}`).push(data);
  }
  resetForm();
}

/* ================= LOAD ================= */
function loadAssignments(){
  db.ref(`requirements/${courseId}`).on("value",s=>{
    list.innerHTML="";
    if(!s.exists()){
      list.innerHTML="<p class='meta'>No assignments</p>";
      return;
    }

    s.forEach(r=>{
      const d=r.val();
      const div=document.createElement("div");
      div.className="assign";

      div.innerHTML=`
        <h4>${d.title}</h4>
        <p>${d.description||""}</p>
        <div class="meta">Deadline: ${new Date(d.deadline).toLocaleString()}</div>

        <div class="actions">
          <button class="secondary" onclick="editAssign('${r.key}')">Edit</button>
          <button class="outline" onclick="toggle('${r.key}',${!d.active})">
            ${d.active?"Suspend":"Activate"}
          </button>
          <button class="danger" onclick="del('${r.key}')">Delete</button>
          <button onclick="viewSubs('${r.key}')">View Submissions</button>
        </div>

        <div id="subs-${r.key}"></div>
      `;
      list.appendChild(div);
    });
  });
}

/* ================= SUBMISSIONS ================= */
async function viewSubs(reqId){
  const box=document.getElementById("subs-"+reqId);
  box.innerHTML="<p class='meta'>Loading submissions...</p>";

  const subSnap=await db.ref(`submissions/${courseId}/${reqId}`).get();
  if(!subSnap.exists()){
    box.innerHTML="<p class='meta'>No submissions yet.</p>";
    return;
  }

  const studentsSnap=await db.ref("students").get();
  const students=studentsSnap.exists()?studentsSnap.val():{};

  let html=`<table style="width:100%;border-collapse:collapse;margin-top:12px">
    <tr style="background:#f1f5f9">
      <th>S.No</th><th>Name</th><th>Email</th><th>Status</th><th>Action</th><th>File</th>
    </tr>`;

  let i=1;
  subSnap.forEach(s=>{
    const d=s.val();
    const st=Object.values(students).find(x=>x.uid===d.uid)||{};
    html+=`
      <tr>
        <td>${i++}</td>
        <td>${st.name||"Student"}</td>
        <td>${st.email||"-"}</td>
        <td>${d.status}</td>
        <td>
          <button onclick="updateStatus('${reqId}','${s.key}','approved')">Approve</button>
          <button class="danger" onclick="updateStatus('${reqId}','${s.key}','rejected')">Reject</button>
        </td>
        <td>
          <!-- âœ… RAW FILE LINK (WORKS) -->
          <a href="${d.fileURL}" target="_blank" class="outline">Open / Download</a>
        </td>
      </tr>`;
  });

  html+="</table>";
  box.innerHTML=html;
}

/* ================= ACTIONS ================= */
function updateStatus(reqId,subId,status){
  db.ref(`submissions/${courseId}/${reqId}/${subId}/status`).set(status);
}

async function editAssign(id){
  const s=await db.ref(`requirements/${courseId}/${id}`).get();
  if(!s.exists())return;
  const d=s.val();
  title.value=d.title;
  desc.value=d.description;
  deadline.value=d.deadline;
  editId=id;
  formTitle.textContent="Edit Assignment";
}

function resetForm(){
  title.value="";desc.value="";deadline.value="";
  editId=null;formTitle.textContent="Create Assignment";
}

function toggle(id,val){
  db.ref(`requirements/${courseId}/${id}/active`).set(val);
}

function del(id){
  if(confirm("Delete assignment?"))
    db.ref(`requirements/${courseId}/${id}`).remove();
}
</script>

</body>
</html>
