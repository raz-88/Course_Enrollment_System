<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin â€“ Attendance</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>

<style>
body{margin:0;font-family:system-ui;background:#f5f7fb;color:#111}
.container{max-width:1200px;margin:auto;padding:16px}
header{background:#0f172a;color:#fff;padding:14px}
h2{margin:0}

.card{
  background:#fff;border-radius:16px;padding:18px;
  box-shadow:0 6px 20px rgba(15,23,42,.08);
  margin-top:16px
}

input{
  padding:10px;border-radius:10px;
  border:1px solid #d1d5db;width:100%;margin:6px 0
}

button{
  padding:7px 14px;border:none;border-radius:999px;
  cursor:pointer;background:#1b5e20;color:#fff;font-size:.85rem
}
button.secondary{background:#475569}
button.outline{background:transparent;border:1px solid #d1d5db;color:#111}
button.danger{background:#b91c1c}

.slot{
  border:1px solid #e5e7eb;border-radius:14px;
  padding:14px;margin-bottom:14px
}

.meta{font-size:.8rem;color:#6b7280}
.badge{
  padding:3px 10px;border-radius:999px;
  font-size:.75rem;font-weight:600
}
.active{background:#dcfce7;color:#166534}
.suspended{background:#fee2e2;color:#991b1b}
.present{color:#15803d}
.absent{color:#b91c1c}
.notmarked{color:#d97706}

table{width:100%;border-collapse:collapse;margin-top:12px}
th,td{padding:8px;border:1px solid #e5e7eb;text-align:left}
th{background:#f1f5f9}
</style>
</head>

<body>

<header>
  <div class="container">
    <h2>ðŸ§¾ Admin Attendance</h2>
  </div>
</header>

<div class="container">

<!-- CREATE SLOT -->
<div class="card">
  <h3>Create Attendance Slot</h3>
  <label>Date</label>
  <input type="date" id="attDate">
  <label>Start Time</label>
  <input type="time" id="startTime">
  <label>End Time</label>
  <input type="time" id="endTime">
  <button onclick="createSlot()">Create Slot</button>
</div>

<!-- SLOT LIST -->
<div class="card">
  <h3>Attendance Slots</h3>
  <div id="slotList"></div>
</div>

</div>

<script>
/* ================= FIREBASE ================= */
const firebaseConfig={
  apiKey:"AIzaSyBjcNmWxI91atAcnv1ALZM4723Cer6OFGo",
  authDomain:"student-enrollment-39c2f.firebaseapp.com",
  databaseURL:"https://student-enrollment-39c2f-default-rtdb.firebaseio.com",
  projectId:"student-enrollment-39c2f",
  storageBucket:"student-enrollment-39c2f.firebasestorage.app",
  messagingSenderId:"810600465736",
  appId:"1:810600465736:web:953640e6f15a530ee25f7d"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.database(),auth=firebase.auth();

const courseId=new URLSearchParams(location.search).get("courseId");

/* ================= AUTH ================= */
auth.onAuthStateChanged(u=>{
  if(!u) location.href="../auth.html";
  loadSlots();
});

/* ================= CREATE SLOT ================= */
function createSlot(){
  if(!attDate.value||!startTime.value||!endTime.value)
    return alert("All fields required");

  db.ref(`attendanceSlots/${courseId}/${attDate.value}`).set({
    date:attDate.value,
    start:startTime.value,
    end:endTime.value,
    active:true,
    createdAt:Date.now()
  });
}

/* ================= LOAD SLOTS ================= */
function loadSlots(){
  db.ref(`attendanceSlots/${courseId}`).on("value",s=>{
    slotList.innerHTML="";
    if(!s.exists()) return slotList.innerHTML="<p class='meta'>No slots</p>";

    s.forEach(slot=>{
      const d=slot.val();
      slotList.innerHTML+=`
        <div class="slot">
          <b>${d.date}</b>
          <div class="meta">
            ${d.start} â€“ ${d.end}
          </div>
          <span class="badge ${d.active?"active":"suspended"}">
            ${d.active?"Active":"Suspended"}
          </span>

          <div style="margin-top:8px">
            <button class="outline" onclick="toggleSlot('${slot.key}',${!d.active})">
              ${d.active?"Suspend":"Activate"}
            </button>
            <button onclick="viewAttendance('${slot.key}')">View Attendance</button>
          </div>

          <div id="att-${slot.key}"></div>
        </div>
      `;
    });
  });
}

/* ================= VIEW ATTENDANCE ================= */
async function viewAttendance(date){
  const box=document.getElementById("att-"+date);
  box.innerHTML="<p class='meta'>Loading attendance...</p>";

  const [enrollSnap,attSnap,studentsSnap,groupsSnap]=await Promise.all([
    db.ref(`enrollments/${courseId}`).get(),
    db.ref(`attendance/${courseId}/${date}`).get(),
    db.ref("students").get(),
    db.ref(`groups/${courseId}`).get()
  ]);

  const enrolled=[],present=new Set();
  enrollSnap.forEach(e=>enrolled.push(e.key));
  if(attSnap.exists()) attSnap.forEach(a=>present.add(a.key));

  const students=studentsSnap.val()||{},groups=groupsSnap.val()||{};
  let i=1,html=`
    <table>
      <tr>
        <th>S.No</th><th>Name</th><th>Email</th>
        <th>Group</th><th>Position</th><th>Status</th>
      </tr>
  `;

  enrolled.forEach(uid=>{
    let name="Student",email="-",group="-",pos="-";
    Object.values(students).forEach(s=>{
      if(s.uid===uid){name=s.name;email=s.email;}
    });
    Object.values(groups).forEach(t=>{
      Object.values(t).forEach(g=>{
        if(g.members&&g.members[uid]){
          group=g.groupName;pos=g.members[uid].role;
        }
      });
    });

    const status=present.has(uid)?"Present":"Absent";
    html+=`
      <tr>
        <td>${i++}</td><td>${name}</td><td>${email}</td>
        <td>${group}</td><td>${pos}</td>
        <td class="${status==="Present"?"present":"absent"}">${status}</td>
      </tr>
    `;
  });

  box.innerHTML=html+"</table>";
}

/* ================= TOGGLE ================= */
function toggleSlot(date,val){
  db.ref(`attendanceSlots/${courseId}/${date}/active`).set(val);
}
</script>

</body>
</html>
