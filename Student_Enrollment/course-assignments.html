<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Course Assignments</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>

<style>
/* ================= BASE ================= */
body{margin:0;font-family:system-ui;background:#f5f7fb;color:#111}
.container{max-width:1200px;margin:auto;padding:16px}

/* ================= HEADER ================= */
.site-header{background:#1b5e20;color:#fff;padding:12px 0}
.header-inner{display:flex;justify-content:space-between;align-items:center;gap:12px}
.logo{font-size:1.3rem;font-weight:700}
.nav-links a{color:#e8f5e9;text-decoration:none;margin-left:10px}

/* ================= TITLE ================= */
.page-title{
  margin-top:16px;background:#fff;border-radius:16px;
  padding:18px;box-shadow:0 2px 8px rgba(0,0,0,.08)
}

/* ================= ASSIGNMENT CARD ================= */
.assignment{
  background:#fff;border-radius:18px;padding:20px;margin-top:18px;
  box-shadow:0 6px 20px rgba(15,23,42,.08)
}
.assignment h3{margin:0}
.desc{color:#4b5563;font-size:.9rem;margin:6px 0}
.meta{font-size:.85rem;color:#6b7280}

/* ================= BADGES ================= */
.badge{
  display:inline-block;
  padding:4px 12px;
  border-radius:999px;
  font-size:.75rem;
  font-weight:600;
  margin-top:8px
}
.submitted{background:#fef3c7;color:#92400e}
.approved{background:#ecfdf3;color:#166534}
.rejected{background:#fee2e2;color:#b91c1c}
.closed{background:#e5e7eb;color:#374151}

/* ================= UPLOAD BOX ================= */
.upload-box{
  margin-top:14px;
  border:2px dashed #c7e6d3;
  border-radius:14px;
  padding:14px;
  background:#f0fdf4
}
.upload-box input{margin-top:6px}

/* ================= BUTTON ================= */
button{
  margin-top:10px;
  padding:8px 18px;
  border:none;
  border-radius:999px;
  cursor:pointer;
  background:#1b5e20;
  color:#fff;
  font-size:.85rem
}
button:disabled{
  background:#9ca3af;
  cursor:not-allowed
}

/* ================= ERROR TEXT ================= */
.error{
  color:#b91c1c;
  font-size:.8rem;
  margin-top:6px
}

/* ================= EMPTY ================= */
.empty{color:#6b7280;margin-top:10px}
</style>
</head>

<body>

<header class="site-header">
  <div class="container header-inner">
    <div class="logo">Learning Engagement Portal</div>
    <nav class="nav-links">
      <a href="../index.html">Home</a>
      <a href="student-my-enrollments.html">My Enrollments</a>
    </nav>
  </div>
</header>

<div class="container">

<div class="page-title">
  <h2 id="courseName">Assignments</h2>
  <p id="courseDesc"></p>
</div>

<div id="assignmentList"></div>

</div>

<script>
/* ================= FIREBASE ================= */
const firebaseConfig={
  apiKey:"AIzaSyBjcNmWxI91atAcnv1ALZM4723Cer6OFGo",
  authDomain:"student-enrollment-39c2f.firebaseapp.com",
  databaseURL:"https://student-enrollment-39c2f-default-rtdb.firebaseio.com",
  projectId:"student-enrollment-39c2f",
  storageBucket:"student-enrollment-39c2f.firebasestorage.app",
  messagingSenderId:"810600465736",
  appId:"1:810600465736:web:953640e6f15a530ee25f7d"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.database(),auth=firebase.auth();

/* ================= GLOBAL ================= */
const courseId=new URLSearchParams(location.search).get("courseId");
const CLOUD_NAME="dguszsb1j";
const UPLOAD_PRESET="student_uploads";
const MAX_FILE_SIZE = 2 * 1024 * 1024; // 2MB

/* ================= AUTH ================= */
auth.onAuthStateChanged(async user=>{
  if(!user) return location.href="../auth.html";
  loadCourse();
  loadAssignments(user);
});

/* ================= COURSE ================= */
async function loadCourse(){
  const s=await db.ref("courses/"+courseId).get();
  if(!s.exists()) return;
  courseName.textContent=s.val().name+" â€“ Assignments";
  courseDesc.textContent=s.val().description||"";
}

/* ================= ASSIGNMENTS ================= */
async function loadAssignments(user){
  const el=assignmentList;
  el.innerHTML="";

  const snap=await db.ref("requirements/"+courseId).get();
  if(!snap.exists()){
    el.innerHTML="<p class='empty'>No assignments available.</p>";
    return;
  }

  snap.forEach(r=>{
    const id=r.key,d=r.val();
    const deadline=d.deadline?new Date(d.deadline):null;
    const now=new Date();
    const beforeDeadline=deadline?now<=deadline:true;

    const card=document.createElement("div");
    card.className="assignment";
    card.innerHTML=`
      <h3>${d.title}</h3>
      <p class="desc">${d.description||""}</p>
      <div class="meta">Deadline: ${deadline?deadline.toLocaleString():"No deadline"}</div>

      <div class="upload-box">
        <input type="file" id="file-${id}">
        <div id="err-${id}" class="error"></div>
        <button id="btn-${id}" ${beforeDeadline?"":"disabled"}>
          ${beforeDeadline?"Upload Assignment":"Closed"}
        </button>
      </div>

      <div id="status-${id}"></div>
    `;
    el.appendChild(card);

    const btn=document.getElementById("btn-"+id);

    btn.onclick=()=>uploadAssignment(id,user.uid);

    db.ref(`submissions/${courseId}/${id}/${user.uid}`)
      .on("value",s=>{
        if(!s.exists()) return;
        const st=s.val().status;
        btn.disabled=true;
        btn.textContent="Submitted";
        document.getElementById("status-"+id).innerHTML=
          `<span class="badge ${st}">${st}</span>`;
      });
  });
}

/* ================= UPLOAD ================= */
async function uploadAssignment(reqId,uid){
  const fileInput=document.getElementById("file-"+reqId);
  const errorEl=document.getElementById("err-"+reqId);
  const file=fileInput.files[0];
  if(!file) return alert("Please select a file");

  // ðŸ”’ FILE SIZE CHECK
  if(file.size > MAX_FILE_SIZE){
    errorEl.textContent="File size must be 2 MB or less.";
    return;
  }
  errorEl.textContent="";

  const btn=document.getElementById("btn-"+reqId);
  btn.disabled=true;
  btn.textContent="Uploading...";

  const fd=new FormData();
  fd.append("file",file);
  fd.append("upload_preset",UPLOAD_PRESET);

  const res=await fetch(
    `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/auto/upload`,
    {method:"POST",body:fd}
  );
  const data=await res.json();

  await db.ref(`submissions/${courseId}/${reqId}/${uid}`).set({
    fileName:file.name,
    fileURL: data.secure_url.replace("/image/upload/", "/raw/upload/"),

    status:"submitted",
    submittedAt:Date.now()
  });

  btn.textContent="Submitted";
}
</script>

</body>
</html>
