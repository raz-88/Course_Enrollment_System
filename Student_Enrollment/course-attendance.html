<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Course Attendance</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>

<style>
/* ===== BASE ===== */
body{margin:0;font-family:system-ui;background:#f5f7fb;color:#111}
.container{max-width:1200px;margin:auto;padding:16px}

/* ===== HEADER ===== */
.site-header{background:#1b5e20;color:#fff;padding:12px 0}
.header-inner{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
.logo{font-size:1.3rem;font-weight:700}
.nav-links a{color:#e8f5e9;text-decoration:none;margin-left:10px;font-size:.9rem}

/* ===== TITLE ===== */
.page-title{
  margin-top:16px;background:#fff;border-radius:16px;
  padding:18px;box-shadow:0 2px 8px rgba(0,0,0,.08)
}
.page-title p{color:#4b5563}

/* ===== SLOT CARD ===== */
.slot{
  background:#fff;border-radius:16px;padding:18px;margin-top:16px;
  box-shadow:0 2px 10px rgba(15,23,42,.08)
}
.slot h3{margin:0;font-size:1.05rem}
.meta{font-size:.85rem;color:#6b7280;margin:6px 0}

/* ===== BUTTON ===== */
button{
  padding:7px 16px;border:none;border-radius:999px;
  cursor:pointer;background:#1b5e20;color:#fff;font-size:.85rem
}
button:disabled{background:#9ca3af;cursor:not-allowed}

/* ===== STATUS ===== */
.badge{
  display:inline-block;
  margin-top:8px;
  padding:4px 12px;
  border-radius:999px;
  font-size:.8rem;
  font-weight:600
}
.present{background:#dcfce7;color:#166534}
.missed{background:#fee2e2;color:#991b1b}
.pending{background:#fffbeb;color:#92400e}

/* ===== SECTIONS ===== */
.section-title{margin-top:30px;font-size:1.1rem}
.empty{color:#6b7280;margin-top:10px}
</style>
</head>

<body>

<!-- HEADER -->
<header class="site-header">
  <div class="container header-inner">
    <div class="logo">Learning Engagement Portal</div>
    <nav class="nav-links">
      <a href="../index.html">Home</a>
      <a href="student-my-enrollments.html">My Enrollments</a>
    </nav>
  </div>
</header>

<div class="container">

<!-- TITLE -->
<div class="page-title">
  <h2 id="courseName">Attendance</h2>
  <p id="courseDesc"></p>
</div>

<!-- ACTIVE -->
<h3 class="section-title">ðŸŸ¢ Active Attendance</h3>
<div id="activeSlots"></div>

<!-- HISTORY -->
<h3 class="section-title">ðŸ“œ Attendance History</h3>
<div id="historySlots"></div>

</div>

<script>
/* ===== FIREBASE ===== */
const firebaseConfig={
 apiKey:"AIzaSyBjcNmWxI91atAcnv1ALZM4723Cer6OFGo",
 authDomain:"student-enrollment-39c2f.firebaseapp.com",
 databaseURL:"https://student-enrollment-39c2f-default-rtdb.firebaseio.com",
 projectId:"student-enrollment-39c2f",
 storageBucket:"student-enrollment-39c2f.firebasestorage.app",
 messagingSenderId:"810600465736",
 appId:"1:810600465736:web:953640e6f15a530ee25f7d"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.database(),auth=firebase.auth();

const courseId=new URLSearchParams(location.search).get("courseId");

/* ===== AUTH ===== */
auth.onAuthStateChanged(user=>{
 if(!user) location.href="../auth.html";
 loadCourse();
 loadAttendance(user);
});

/* ===== COURSE ===== */
async function loadCourse(){
 const s=await db.ref("courses/"+courseId).get();
 if(!s.exists()) return;
 courseName.textContent=s.val().name+" â€“ Attendance";
 courseDesc.textContent=s.val().description||"";
}

/* ===== ATTENDANCE ===== */
function loadAttendance(user){
 const today=new Date().toISOString().slice(0,10);

 db.ref("attendanceSlots/"+courseId).on("value",snap=>{
   activeSlots.innerHTML="";
   historySlots.innerHTML="";

   if(!snap.exists()){
     activeSlots.innerHTML="<p class='empty'>No attendance slots available.</p>";
     return;
   }

   snap.forEach(slot=>{
     const d=slot.val();
     const date=slot.key;

     const start=new Date(`${date}T${d.start}`);
     const end=new Date(`${date}T${d.end}`);
     const now=new Date();

     const statusRef=db.ref(`attendance/${courseId}/${date}/${user.uid}`);

     // ===== TODAY (ACTIVE) =====
     if(date===today && d.active){
       const card=document.createElement("div");
       card.className="slot";

       card.innerHTML=`
         <h3>${date}</h3>
         <div class="meta">Time: ${d.start} â€“ ${d.end}</div>
         <div id="status-${date}" class="badge pending">Pending</div>
         <br>
         <button id="btn-${date}">Mark Present</button>
       `;

       activeSlots.appendChild(card);

       const btn=document.getElementById("btn-"+date);
       const badge=document.getElementById("status-"+date);

       statusRef.on("value",s=>{
         if(s.exists()){
           badge.textContent=s.val();
           badge.className="badge "+s.val();
           btn.disabled=true;
         }
       });

       // Time restriction
       if(now<start||now>end) btn.disabled=true;

       btn.onclick=()=>{
         statusRef.set("present");
       };

       // Auto-miss
       if(now>end){
         statusRef.once("value",s=>{
           if(!s.exists()) statusRef.set("missed");
         });
       }

     } else {
       // ===== HISTORY =====
       statusRef.once("value",s=>{
         const card=document.createElement("div");
         card.className="slot";
         const st=s.val()||"missed";

         card.innerHTML=`
           <h3>${date}</h3>
           <div class="meta">Time: ${d.start} â€“ ${d.end}</div>
           <div class="badge ${st}">${st}</div>
         `;
         historySlots.appendChild(card);
       });
     }
   });
 });
}
</script>

</body>
</html>
