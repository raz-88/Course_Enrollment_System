<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>User ‚Äì Upload Requirements</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>

<style>
body {
  margin: 0;
  font-family: "Segoe UI", sans-serif;
  background: #f4f6f9;
}

.container {
  max-width: 1100px;
  margin: 30px auto;
  padding: 20px;
}

h2 {
  margin-bottom: 20px;
}

/* Card Grid */
.grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 20px;
}

.card {
  background: #fff;
  padding: 20px;
  border-radius: 14px;
  box-shadow: 0 6px 18px rgba(0,0,0,0.08);
  transition: transform .2s;
}

.card:hover {
  transform: translateY(-6px);
}

.card h3 {
  margin-bottom: 8px;
}

.card p {
  font-size: 14px;
  color: #555;
}

.deadline {
  font-size: 13px;
  margin: 8px 0;
}

input[type=file] {
  margin-top: 10px;
}

button {
  margin-top: 10px;
  padding: 8px 14px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  background: #2563eb;
  color: #fff;
}

button:disabled {
  background: #9ca3af;
  cursor: not-allowed;
}

.status {
  margin-top: 10px;
  font-size: 13px;
  font-weight: bold;
}

.pending { color: #d97706; }
.approved { color: #15803d; }
.rejected { color: #b91c1c; }
</style>
</head>

<body>

<div class="container">
  <h2>üì§ Upload Requirements</h2>
  <div class="grid" id="requirementGrid"></div>
</div>

<script>
/* üî• FIREBASE CONFIG (REPLACE) */
const firebaseConfig = {
  apiKey: "AIzaSyBjcNmWxI91atAcnv1ALZM4723Cer6OFGo",
  authDomain: "student-enrollment-39c2f.firebaseapp.com",
  databaseURL: "https://student-enrollment-39c2f-default-rtdb.firebaseio.com",
  projectId: "student-enrollment-39c2f",
  storageBucket: "student-enrollment-39c2f.firebasestorage.app",
  messagingSenderId: "810600465736",
  appId: "1:810600465736:web:953640e6f15a530ee25f7d"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const auth = firebase.auth();

/* üîê Auto-login (for testing only) */
auth.signInAnonymously();

/* ‚òÅÔ∏è CLOUDINARY DETAILS */
const CLOUD_NAME = "dguszsb1j";
const UPLOAD_PRESET = "student_uploads";

/* üì• Load Requirements */
auth.onAuthStateChanged(user => {
  if (!user) return;

  db.ref("requirements").on("value", snap => {
    const grid = document.getElementById("requirementGrid");
    grid.innerHTML = "";

    snap.forEach(req => {
      const r = req.val();
      if (!r.enabled) return;

      const deadlinePassed = r.deadline && new Date(r.deadline) < new Date();

      const card = document.createElement("div");
      card.className = "card";

      card.innerHTML = `
        <h3>${r.title}</h3>
        <p>${r.description}</p>
        <div class="deadline">
          ‚è∞ Deadline: ${r.deadline || "No deadline"}
        </div>

        <input type="file" id="file-${req.key}" ${deadlinePassed ? "disabled" : ""}>
        <button ${deadlinePassed ? "disabled" : ""} 
          onclick="uploadFile('${req.key}')">
          Upload / Re-upload
        </button>

        <div class="status" id="status-${req.key}">Not Submitted</div>
      `;

      grid.appendChild(card);

      loadSubmissionStatus(req.key, user.uid);
    });
  });
});

/* üì§ Upload File */
async function uploadFile(reqId) {
  const user = auth.currentUser;
  const fileInput = document.getElementById("file-" + reqId);
  const statusEl = document.getElementById("status-" + reqId);

  if (!fileInput.files.length) {
    alert("Please select a file");
    return;
  }

  const file = fileInput.files[0];

  if (file.size > 10 * 1024 * 1024) {
    alert("File must be under 10MB");
    return;
  }

  statusEl.textContent = "Uploading...";
  statusEl.className = "status pending";

  const formData = new FormData();
  formData.append("file", file);
  formData.append("upload_preset", UPLOAD_PRESET);

  const res = await fetch(
    `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/auto/upload`,
    { method: "POST", body: formData }
  );

  const data = await res.json();

  await db.ref(`submissions/${reqId}/${user.uid}`).set({
    fileName: file.name,
    fileURL: data.secure_url,
    uploadedAt: Date.now(),
    status: "pending",
    adminRemark: ""
  });

  statusEl.textContent = "Pending Review";
  statusEl.className = "status pending";
}

/* üìä Load Submission Status */
function loadSubmissionStatus(reqId, userId) {
  const statusEl = document.getElementById("status-" + reqId);

  db.ref(`submissions/${reqId}/${userId}`).on("value", snap => {
    if (!snap.exists()) return;

    const s = snap.val();
    statusEl.textContent = s.status.toUpperCase();
    statusEl.className = "status " + s.status;
  });
}
</script>

</body>
</html>
